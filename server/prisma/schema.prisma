generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Marketplace (Listing) ---

model Listing {
  id             String         @id @default(cuid())
  userId         String
  title          String
  description    String?
  category       ListingCategory
  game           Game
  language       Language
  condition      CardCondition
  setCode        String?
  cardId         String?
  cardName       String?
  edition        String?
  attributesJson Json?
  quantity       Int            @default(1)
  priceCents     Int
  currency       String         @default("EUR")
  status         ListingStatus  @default(DRAFT)
  isHidden       Boolean        @default(false)
  publishedAt    DateTime?
  soldAt         DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  events         ListingEvent[]
  handovers      Handover[]
  images         ListingImage[]
  favorites      Favorite[]
  reports        ListingReport[]
  purchaseOrders PurchaseOrder[]
  shipping       ListingShipping?
  questions      ListingQuestion[]

  @@index([userId])
  @@index([status, createdAt])
  @@index([status, publishedAt])
  @@index([status, priceCents])
  @@index([userId, status])
  @@index([game, language, condition])
  @@index([cardId])
  @@index([setCode])
  @@index([isHidden])
}

enum ListingCategory {
  CARD
  SEALED
  ACCESSORY
}

enum Game {
  POKEMON
  ONE_PIECE
  MTG
  YUGIOH
  LORCANA
  OTHER
}

enum Language {
  FR
  EN
  JP
  DE
  ES
  IT
  OTHER
}

enum CardCondition {
  NM
  LP
  MP
  HP
  DMG
}

enum ListingStatus {
  DRAFT
  PUBLISHED
  SOLD
  ARCHIVED
}

model ListingEvent {
  id          String          @id @default(cuid())
  listingId   String
  listing     Listing         @relation(fields: [listingId], references: [id], onDelete: Cascade)
  type        ListingEventType
  actorUserId String
  metadataJson Json?
  createdAt   DateTime        @default(now())

  @@index([listingId])
  @@index([actorUserId])
}

enum ListingEventType {
  CREATED
  PUBLISHED
  UPDATED
  SOLD
  ARCHIVED
}

model ListingImage {
  id          String   @id @default(cuid())
  listingId   String
  storageKey  String
  sortOrder   Int      @default(0)
  contentType String?
  createdAt   DateTime @default(now())

  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([listingId])
}

// --- Favorites (wishlist listings) ---

model Favorite {
  id        String   @id @default(cuid())
  userId    String
  listingId String
  createdAt DateTime @default(now())

  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([userId, listingId])
  @@index([userId])
  @@index([listingId])
}

// --- Trade (UserCollection, TradeOffer) ---

model UserCollection {
  id        String        @id @default(cuid())
  userId    String
  cardId    String
  cardName  String?
  setCode   String?
  game      Game?
  language  Language
  condition CardCondition
  quantity  Int           @default(1)
  isPublic  Boolean       @default(false)
  acquiredAt             DateTime?
  acquisitionPriceCents Int?
  acquisitionCurrency   String?   @default("EUR")
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@unique([userId, cardId, language, condition])
  @@index([userId])
  @@index([userId, isPublic])
  @@index([cardId])
}

// creatorItemsJson / receiverItemsJson : JSON avec au minimum { "schemaVersion": number } en racine.
// schemaVersion permet d'évoluer le format des items (cartes, quantités, conditions) sans casser l'existant.
model TradeOffer {
  id                  String            @id @default(cuid())
  creatorUserId       String
  receiverUserId      String
  creatorItemsJson    Json
  receiverItemsJson   Json
  status              TradeOfferStatus  @default(PENDING)
  expiresAt           DateTime?
  counterOfOfferId    String?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  events              TradeEvent[]
  messages            TradeMessage[]
  readStates          TradeReadState[]
  handovers           Handover[]
  counterOf           TradeOffer?       @relation("CounterOffer", fields: [counterOfOfferId], references: [id], onDelete: SetNull)
  counters            TradeOffer[]     @relation("CounterOffer")

  @@index([creatorUserId])
  @@index([receiverUserId])
  @@index([status, createdAt])
  @@index([status, expiresAt])
  @@index([counterOfOfferId])
}

enum TradeOfferStatus {
  PENDING
  ACCEPTED
  REJECTED
  CANCELLED
  EXPIRED
}

model TradeEvent {
  id            String         @id @default(cuid())
  tradeOfferId  String
  tradeOffer    TradeOffer     @relation(fields: [tradeOfferId], references: [id], onDelete: Cascade)
  type          TradeEventType
  actorUserId   String
  metadataJson  Json?
  createdAt     DateTime       @default(now())

  @@index([tradeOfferId])
  @@index([actorUserId])
}

enum TradeEventType {
  CREATED
  ACCEPTED
  REJECTED
  CANCELLED
  EXPIRED
  COUNTERED
}

model TradeMessage {
  id            String     @id @default(cuid())
  tradeOfferId  String
  senderUserId  String
  body          String
  createdAt     DateTime   @default(now())

  tradeOffer TradeOffer @relation(fields: [tradeOfferId], references: [id], onDelete: Cascade)

  @@index([tradeOfferId, createdAt, id])
}

model TradeReadState {
  id            String     @id @default(cuid())
  tradeOfferId  String
  userId        String
  lastReadAt    DateTime?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  tradeOffer TradeOffer @relation(fields: [tradeOfferId], references: [id], onDelete: Cascade)

  @@unique([tradeOfferId, userId])
  @@index([userId, updatedAt])
}

// --- User Profile (local cache) ---

model UserProfile {
  id           String   @id @default(cuid())
  userId       String   @unique
  username     String
  avatarUrl    String?
  bio          String?
  country      String?
  trustScore   Float    @default(0)
  tradeCount   Int      @default(0)
  listingCount Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([username])
}

// --- Analytics (Price Snapshots) ---

model PriceSnapshot {
  id               String   @id @default(cuid())
  cardId           String
  language         Language
  day              DateTime @db.Date
  medianPriceCents Int
  minPriceCents    Int
  maxPriceCents    Int
  volume           Int
  createdAt        DateTime @default(now())

  @@unique([cardId, language, day])
  @@index([cardId, language])
}

// --- Stop-loss (Price Alerts) ---

model PriceAlert {
  id             String         @id @default(cuid())
  userId         String
  cardId         String
  language       Language
  thresholdCents Int
  direction      AlertDirection
  active         Boolean        @default(true)
  triggeredAt    DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@index([userId])
  @@index([cardId, language])
  @@index([active, direction])
}

enum AlertDirection {
  DROP
  RISE
}

// --- P1: Remise en main propre (anti-fake) ---

model Handover {
  id                String         @id @default(cuid())
  listingId         String?
  tradeOfferId      String?
  status            HandoverStatus @default(PENDING_VERIFICATION)
  requestedByUserId String
  verifiedByUserId  String?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  listing    Listing?    @relation(fields: [listingId], references: [id], onDelete: Cascade)
  tradeOffer TradeOffer? @relation(fields: [tradeOfferId], references: [id], onDelete: Cascade)

  @@index([requestedByUserId])
  @@index([status])
  @@index([requestedByUserId, status])
  @@index([listingId])
  @@index([tradeOfferId])
}

enum HandoverStatus {
  PENDING_VERIFICATION
  VERIFIED
  REJECTED
}

// --- Trust / Moderation ---

model ListingReport {
  id              String             @id @default(cuid())
  listingId       String
  reporterUserId  String
  reason          String
  details         String?
  status          ListingReportStatus @default(OPEN)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([listingId, status, createdAt])
  @@index([reporterUserId, createdAt])
}

enum ListingReportStatus {
  OPEN
  RESOLVED
  REJECTED
}

model ModerationAction {
  id          String               @id @default(cuid())
  targetType  ModerationTargetType
  targetId    String
  actionType  ModerationActionType
  note        String?
  actorUserId String
  createdAt   DateTime             @default(now())

  @@index([targetType, targetId, createdAt])
  @@index([actorUserId, createdAt])
}

enum ModerationTargetType {
  LISTING
  USER
  TRADE
}

enum ModerationActionType {
  HIDE
  UNHIDE
  WARN
  BAN
  UNBAN
  NOTE
}

model UserModerationState {
  id         String    @id @default(cuid())
  userId     String    @unique
  isBanned   Boolean   @default(false)
  banReason  String?
  bannedAt   DateTime?
  warnCount  Int       @default(0)
  lastWarnAt DateTime?
  updatedAt  DateTime  @updatedAt

  @@index([isBanned])
  @@index([warnCount])
}

model SellerReputation {
  id             String   @id @default(cuid())
  userId         String   @unique
  score          Int      @default(0)
  totalSales     Int      @default(0)
  totalTrades    Int      @default(0)
  disputesCount  Int      @default(0)
  reportsCount   Int      @default(0)
  ratingSum      Int      @default(0)
  ratingCount    Int      @default(0)
  updatedAt      DateTime @updatedAt

  @@index([score])
}

// --- User Profile Types (role-based features) ---

enum UserProfileType {
  COLLECTOR
  SELLER
  TRADER
  INVESTOR
}

model UserActiveProfile {
  id          String          @id @default(cuid())
  userId      String
  profileType UserProfileType
  createdAt   DateTime        @default(now())

  @@unique([userId, profileType])
  @@index([userId])
}

// --- Pricing + Portfolio (external market data) ---

enum PriceSource {
  CARDMARKET
  TCGPLAYER
  TCGDEX
}

model ExternalProductRef {
  id                 String      @id @default(cuid())
  source             PriceSource
  game               Game
  cardId             String
  language           Language?
  externalProductId  String
  createdAt          DateTime    @default(now())

  @@unique([source, externalProductId])
  @@index([cardId, language])
}

model CardPriceSnapshot {
  id                String      @id @default(cuid())
  source            PriceSource
  externalProductId String
  currency          String      @default("EUR")
  trendCents        Int
  avgCents          Int?
  lowCents          Int?
  capturedAt        DateTime    @default(now())

  @@index([externalProductId, capturedAt])
  @@index([source, capturedAt])
}

model DailyPriceSnapshot {
  id          String      @id @default(cuid())
  cardId      String
  language    Language
  source      PriceSource @default(TCGDEX)
  day         DateTime    @db.Date
  capturedAt  DateTime    @default(now())
  trendCents  Int
  lowCents    Int?
  avgCents    Int?
  highCents   Int?
  avg7Cents   Int?
  avg30Cents  Int?
  rawJson     Json?

  @@unique([cardId, language, source, day])
  @@index([cardId, language, day(sort: Desc)])
}

model UserPortfolioSnapshot {
  id              String   @id @default(cuid())
  userId          String
  totalValueCents Int
  totalCostCents  Int
  pnlCents        Int
  capturedAt      DateTime @default(now())

  @@index([userId, capturedAt])
}

// --- Notifications ---

enum NotificationType {
  TRADE_OFFER_RECEIVED
  TRADE_OFFER_ACCEPTED
  TRADE_OFFER_REJECTED
  TRADE_OFFER_CANCELLED
  TRADE_OFFER_COUNTERED
  TRADE_MESSAGE_RECEIVED
  LISTING_SOLD
  LISTING_QUESTION_RECEIVED
  LISTING_QUESTION_ANSWERED
  PRICE_ALERT_TRIGGERED
  PURCHASE_ORDER_RECEIVED
  PURCHASE_ORDER_COMPLETED
  PURCHASE_ORDER_CANCELLED
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  body      String
  dataJson  Json?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  @@index([userId, isRead, createdAt])
  @@index([userId, createdAt])
}

// --- Purchase Orders ---

enum PurchaseOrderStatus {
  PENDING
  COMPLETED
  CANCELLED
  FAILED
}

model PurchaseOrder {
  id             String              @id @default(cuid())
  buyerUserId    String
  listingId      String
  status         PurchaseOrderStatus @default(PENDING)
  priceCents     Int
  currency       String              @default("EUR")
  externalRef    String?
  webhookEventId String?             @unique
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  listing Listing @relation(fields: [listingId], references: [id])

  @@index([buyerUserId, status, createdAt])
  @@index([listingId, status])
}

// --- Shipping ---

enum ShippingMethod {
  PICKUP
  COLISSIMO
  MONDIAL_RELAY
  LETTRE_SUIVIE
  OTHER
}

model ListingShipping {
  id            String         @id @default(cuid())
  listingId     String         @unique
  method        ShippingMethod
  isFree        Boolean        @default(false)
  priceCents    Int?
  currency      String         @default("EUR")
  estimatedDays String?
  description   String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  listing Listing @relation(fields: [listingId], references: [id])
}

// --- Seller Reviews ---

model SellerReview {
  id             String   @id @default(cuid())
  reviewerUserId String
  sellerUserId   String
  rating         Int
  comment        String?
  listingId      String?
  tradeOfferId   String?
  createdAt      DateTime @default(now())

  @@unique([reviewerUserId, listingId])
  @@unique([reviewerUserId, tradeOfferId])
  @@index([sellerUserId, createdAt])
}

// --- Listing Q&A ---

model ListingQuestion {
  id          String    @id @default(cuid())
  listingId   String
  askerId     String
  question    String
  answer      String?
  answeredAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  listing Listing @relation(fields: [listingId], references: [id])

  @@index([listingId, createdAt])
  @@index([askerId, createdAt])
}

// --- Job snapshot-all : curseur pour reprise après crash ---
model JobCursor {
  jobId      String   @id
  cursorPage Int      @default(1)
  cursorLang Int      @default(0)
  updatedAt  DateTime @updatedAt

  @@map("job_cursors")
}
